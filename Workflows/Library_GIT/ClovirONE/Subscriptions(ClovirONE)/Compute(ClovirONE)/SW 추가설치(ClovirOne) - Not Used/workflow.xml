<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item34" object-name="workflow:name=generic" id="16b4815b-abdc-4168-983f-b82f7eebd392" version="1.0.7" api-version="6.0.0" allowed-operations="vfe" editor-version="2.0" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[SW 추가설치(ClovirOne) - Not Used]]></display-name>
  <description><![CDATA[APP 추가 workflow]]></description>
  <position y="95.65273206179938" x="17.851711652511725"/>
  <input>
    <param name="inputProperties" type="Properties"/>
  </input>
  <attrib name="_install_script" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_vm_object" type="VC:VirtualMachine" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_scriptTimeout" type="number" read-only="false">
    <value encoded="n"><![CDATA[4200.0]]></value>
  </attrib>
  <attrib name="_script_output" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_error" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_application_number" type="number" read-only="false">
    <value encoded="n"><![CDATA[0.0]]></value>
  </attrib>
  <attrib name="_app_param_string" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_linux_script_type" type="string" read-only="false">
    <value encoded="n"><![CDATA[bash]]></value>
  </attrib>
  <attrib name="_windows_script_type" type="string" read-only="false">
    <value encoded="n"><![CDATA[powershell]]></value>
  </attrib>
  <attrib name="pollingRate" type="number" read-only="false">
    <value encoded="n"><![CDATA[1.0]]></value>
  </attrib>
  <attrib name="timeout" type="number" read-only="false">
    <value encoded="n"><![CDATA[30.0]]></value>
  </attrib>
  <attrib name="_script_ExitCode" type="number" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="sleepTime" type="number" read-only="false">
    <value encoded="n"><![CDATA[20.0]]></value>
  </attrib>
  <attrib name="windows_sleep" type="number" read-only="false">
    <value encoded="n"><![CDATA[240.0]]></value>
  </attrib>
  <attrib name="repoinfo" type="string" read-only="false" conf-id="6fc1e0c6-ae7c-46d0-9ab3-f4b2e115d9db" conf-key="repoServer">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_is_linux" type="boolean" read-only="false">
    <value encoded="n"><![CDATA[false]]></value>
  </attrib>
  <attrib name="_guest_win_id" type="string" read-only="false" conf-id="8fd52cf1-d098-4d3a-933b-3a7116371bf5" conf-key="guest_win_id">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_guest_lin_id" type="string" read-only="false" conf-id="8fd52cf1-d098-4d3a-933b-3a7116371bf5" conf-key="guest_lin_id">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="_guest_lin_pwd" type="SecureString" read-only="false" conf-id="8fd52cf1-d098-4d3a-933b-3a7116371bf5" conf-key="guest_lin_pwd"/>
  <attrib name="_guest_win_pwd" type="SecureString" read-only="false" conf-id="8fd52cf1-d098-4d3a-933b-3a7116371bf5" conf-key="guest_win_pwd"/>
  <attrib name="app_pak" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="app_pak_param" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <workflow-note x="635.0" y="197.4000015258789" w="458.0" h="202.0">
    <description><![CDATA[Run Winodws Application Install ]]></description>
  </workflow-note>
  <workflow-note x="641.0" y="3.399993896484375" w="457.0" h="173.5">
    <description><![CDATA[Run Linux Application Install]]></description>
  </workflow-note>
  <workflow-note x="213.0" y="7.8984375" w="362.0" h="116.0">
    <description><![CDATA[Run Linux OS Script and basic config ]]></description>
  </workflow-note>
  <workflow-item name="item4" out-name="item7" type="condition" alt-out-name="item9" comparator="0">
    <display-name><![CDATA[Linux or Windows]]></display-name>
    <script encoded="false"><![CDATA[// Generated by the system, cannot be edited
return (_is_linux === true);]]></script>
    <in-binding>
      <bind name="_is_linux" type="boolean" export-name="_is_linux"/>
    </in-binding>
    <out-binding/>
    <condition name="_is_linux" type="boolean" comparator="0" label="null"/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="59.009888515806736" x="446.96551254437213"/>
  </workflow-item>
  <workflow-item name="item5" out-name="item30" type="task">
    <display-name><![CDATA[Get data from vRA and prepare them]]></display-name>
    <script encoded="false"><![CDATA[//사용할 변수 선언 
var vm_name = inputProperties.resourceNames[0];
if(app_pak_param == null){
    _app_param_string = "";
}
else{
    _app_param_string =  app_pak_param.join(",");
}


//VM은 VM OBJECT TYPE으로 Return 
_vm_object = VcPlugin.getAllVirtualMachines(null, "xpath:name=\'"+ vm_name + "\'")[0];
if(_vm_object == null){
    throw "VM(" + vm_name + ")이 없습니다.";
}
_application_number = 0;
if(app_pak != null){
_application_number = app_pak.length;  
} 
_is_linux = _vm_object.guestOS.indexOf("Windows")<0;
System.log("VM to run: " + _vm_object + "," + _vm_object.guestOS );
System.log("How many applications?: " + _application_number);
System.log("parameter?: " + _app_param_string);]]></script>
    <in-binding>
      <bind name="inputProperties" type="Properties" export-name="inputProperties"/>
      <bind name="app_pak" type="Array/string" export-name="app_pak"/>
      <bind name="app_pak_param" type="Array/string" export-name="app_pak_param"/>
    </in-binding>
    <out-binding>
      <bind name="_vm_object" type="VC:VirtualMachine" export-name="_vm_object"/>
      <bind name="_application_number" type="number" export-name="_application_number"/>
      <bind name="_is_linux" type="boolean" export-name="_is_linux"/>
      <bind name="_app_param_string" type="string" export-name="_app_param_string"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="120.0" x="200.0"/>
  </workflow-item>
  <workflow-item name="item6" type="end" end-mode="0">
    <in-binding/>
    <position y="3.454332960251179" x="1382.5210680999276"/>
  </workflow-item>
  <workflow-item name="item7" out-name="item10" type="custom-condition" alt-out-name="item6">
    <display-name><![CDATA[More Applications to deploy?]]></display-name>
    <script encoded="false"><![CDATA[//Application 개수 확인 
System.log("More applications to deploy?: " + _application_number);

//Applicaiton 개수가 양수일 경우 Applicaiton 진행 시작, 0이거나 음수일 경우 Workflow 종료
if(_application_number > 0){
    
    return true;
}else if(_application_number <= 0){
    System.log("No Applications to install: Finishing");
    return false;
}]]></script>
    <in-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="-0.9901114841932639" x="846.9655125443721"/>
  </workflow-item>
  <workflow-item name="item8" type="end" end-mode="0">
    <in-binding/>
    <position y="241.20229203866631" x="1445.6123008292398"/>
  </workflow-item>
  <workflow-item name="item9" out-name="item13" type="custom-condition" alt-out-name="item8">
    <display-name><![CDATA[More Applications to deploy?]]></display-name>
    <script encoded="false"><![CDATA[//Application 개수 확인 
System.log("More applications to deploy?: " + _application_number);

//Applicaiton 개수가 양수일 경우 Applicaiton 진행 시작, 0이거나 음수일 경우 Workflow 종료
if(_application_number > 0){
   
    return true;
}else if(_application_number <= 0){
    System.log("No Applications to install: Finishing");
    return false;
}]]></script>
    <in-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="227.83497160406242" x="854.5653719194431"/>
  </workflow-item>
  <workflow-item name="item10" out-name="item11" throw-bind-name="err_1" type="task">
    <display-name><![CDATA[Apply application install script]]></display-name>
    <script encoded="false"><![CDATA[//스크립트 내용 초기화
_install_script = "export repo_server=\"" + repoinfo + "\"\n";

//설치할 Application Number와 Application을 Logging
System.log("Application number now:" + _application_number);
System.log("Apps to install:" + app_pak[app_pak.length - _application_number ]);
System.log("App paramaters :" + _app_param_string);



//APPLICATION 목록에서 APPLICATION 개수를 하나 씩 감소해나가면서 설치할 APP을 받아옴
var app = app_pak[app_pak.length - _application_number];
 for each (var p in app_pak_param){
    var temp_string = p
    System.log("Apply Parameters: " + temp_string);
    var temp_array = temp_string.split("=");
    if( temp_array[0] !=''  ){
        _install_script += "export " + temp_array[0] + "=\"" + temp_array[1] + "\"\n";
    }
}
 
//APPLICATION 설치 스크립트 REPO로 부터 다운, 권한 변경, 실행, 삭제 프로세스 진행
_install_script += "wget -d -r -np -nd " + repoinfo + "/app/linux/" + app + "/ " + "-P /tmp/" + app + "/" + " \n";
_install_script += "chmod 755 /tmp/" + app + "/" + app + ".sh" + " \n";
//_install_script += "/tmp/" + app + "/" + app + ".sh " + str_param_list +" \n";
_app_param_string != "" ? _install_script += "sudo " + "/tmp/" + app + "/" + app + ".sh " + _app_param_string + " \n" : _install_script += "sudo " + "/tmp/" + app + "/" + app + ".sh\n";
//_install_script += "rm -r -f /tmp/" + app + "*" + " \n";



System.log("Script to execute: \n" + _install_script);]]></script>
    <in-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
      <bind name="repoinfo" type="string" export-name="repoinfo"/>
      <bind name="_app_param_string" type="string" export-name="_app_param_string"/>
      <bind name="inputProperties" type="Properties" export-name="inputProperties"/>
      <bind name="app_pak" type="Array/string" export-name="app_pak"/>
      <bind name="app_pak_param" type="Array/string" export-name="app_pak_param"/>
    </in-binding>
    <out-binding>
      <bind name="_install_script" type="string" export-name="_install_script"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="39.00988851580674" x="1006.9655125443721"/>
  </workflow-item>
  <workflow-item name="item11" out-name="item19" type="link" linked-workflow-id="f8cd5692-92a0-46b6-a98d-53ffd878d779">
    <display-name><![CDATA[Linux - Run Script in Guest ]]></display-name>
    <in-binding>
      <bind name="vm" type="VC:VirtualMachine" export-name="_vm_object"/>
      <bind name="username" type="string" export-name="_guest_lin_id"/>
      <bind name="password" type="SecureString" export-name="_guest_lin_pwd"/>
      <bind name="scriptType" type="string" export-name="_linux_script_type"/>
      <bind name="script" type="string" export-name="_install_script"/>
      <bind name="scriptTimeout" type="number" export-name="_scriptTimeout"/>
      <bind name="scriptRefreshTime" type="number"/>
      <bind name="scriptWorkingDirectory" type="string"/>
      <bind name="interactiveSession" type="boolean"/>
    </in-binding>
    <out-binding>
      <bind name="scriptOutputText" type="string" export-name="_script_output"/>
      <bind name="scriptExitCode" type="number" export-name="_script_ExitCode"/>
    </out-binding>
    <description><![CDATA[ ]]></description>
    <position y="130.0" x="940.0"/>
  </workflow-item>
  <workflow-item name="item12" out-name="item7" type="task">
    <display-name><![CDATA[Decrease counter ]]></display-name>
    <script encoded="false"><![CDATA[System.log("Application number to decrease: " + _application_number);

//APPLICATION 개수 감소
_application_number = _application_number - 1;
System.log("Application number to changed: " + _application_number);]]></script>
    <in-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
    </in-binding>
    <out-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="49.00988851580674" x="706.9655125443721"/>
  </workflow-item>
  <workflow-item name="item13" out-name="item16" type="task">
    <display-name><![CDATA[Apply application install script]]></display-name>
    <script encoded="false"><![CDATA[//스크립트 내용 초기화
_install_script = "";

//설치할 Application Number와 Application을 Logging
System.log("Application number now:" + _application_number);
System.log("apps to install:" + app_pak[app_pak.length - _application_number]);

//APPLICATION 목록에서 APPLICATION 개수를 하나 씩 감소해나가면서 설치할 APP을 받아옴
var app = app_pak[app_pak.length - _application_number];


//APPLIATION 관련 PARAMETER 적용


for each (var p in app_pak_param){
    System.log("Apply Parameters: " + p);
    var temp_array = p.split("=");
    if( temp_array[0] !=''  ){
        _install_script += "Set-Variable -Name " + temp_array[0] + " -Value \"" + temp_array[1] + "\" \n";
    }
}
 _install_script += "Set-Variable -Name repo_server -Value " +  repoinfo + " \n";
//APPLICATION 설치 스크립트 REPO로 부터 다운, 권한 변경, 실행, 삭제 프로세스 진행
_install_script += "wget   " + repoinfo  + "/app/windows/" + app + "/" + app + ".ps1" + " -O C:\\Temp\\" + app + ".ps1 \n";
_install_script += "C:\\Temp\\" +  app + ".ps1 " + " \n";

//_install_script += "rm C:\\Temp\\" + app + " -recurse -force -confirm:$false \n";

System.log("Script to execute: \n" + _install_script);

]]></script>
    <in-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
      <bind name="repoinfo" type="string" export-name="repoinfo"/>
      <bind name="app_pak" type="Array/string" export-name="app_pak"/>
      <bind name="app_pak_param" type="Array/string" export-name="app_pak_param"/>
    </in-binding>
    <out-binding>
      <bind name="_install_script" type="string" export-name="_install_script"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="310.0" x="1086.6666666666667"/>
  </workflow-item>
  <workflow-item name="item15" out-name="item9" throw-bind-name="err_0" type="task">
    <display-name><![CDATA[Decrease counter ]]></display-name>
    <script encoded="false"><![CDATA[System.log("Application number to decrease: " + _application_number);
_application_number = _application_number - 1;
System.log("Application number to changed: " + _application_number);]]></script>
    <in-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
    </in-binding>
    <out-binding>
      <bind name="_application_number" type="number" export-name="_application_number"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="290.0" x="700.0"/>
  </workflow-item>
  <workflow-item name="item16" out-name="item17" business-status="" throw-bind-name="_error" type="link" linked-workflow-id="f8cd5692-92a0-46b6-a98d-53ffd878d779">
    <display-name><![CDATA[Windows - Run Script in Guest]]></display-name>
    <in-binding>
      <bind name="vm" type="VC:VirtualMachine" export-name="_vm_object"/>
      <bind name="username" type="string" export-name="_guest_win_id"/>
      <bind name="password" type="SecureString" export-name="_guest_win_pwd"/>
      <bind name="scriptType" type="string" export-name="_windows_script_type"/>
      <bind name="script" type="string" export-name="_install_script"/>
      <bind name="scriptTimeout" type="number" export-name="_scriptTimeout"/>
      <bind name="scriptRefreshTime" type="number"/>
      <bind name="scriptWorkingDirectory" type="string"/>
      <bind name="interactiveSession" type="boolean"/>
    </in-binding>
    <out-binding>
      <bind name="scriptOutputText" type="string" export-name="_script_output"/>
      <bind name="scriptExitCode" type="number" export-name="_script_ExitCode"/>
    </out-binding>
    <description><![CDATA[ ]]></description>
    <position y="362.8134031497774" x="1072.2789674959065"/>
  </workflow-item>
  <workflow-item name="item17" out-name="item15" catch-name="item21" throw-bind-name="_error" type="task">
    <display-name><![CDATA[Validate the installation]]></display-name>
    <script encoded="false"><![CDATA[//스크립트 내용 초기화
_install_script = "";
var curr_app = app_pak[app_pak.length - _application_number];
//설치 검증할 APPLICATION 변수로 설정 
System.log("Apps to Validate:" + curr_app);

//해당 APPLICATION에 대해서 스크립트 OUTPUT 을 찾아 해당 내용이 있으면 통과 
if(_script_ExitCode == "0") {
    System.log(curr_app + " - successfully installed")
    
     
    _install_script += "rm C:\\Temp\\"   + " -recurse -force -confirm:$false \n";

    System.log("Script to execute: \n" + _install_script);
}
else {
    System.log(curr_app + " - install failed")
    _error = curr_app + " - install failed"
    throw _error
}]]></script>
    <in-binding>
      <bind name="_script_output" type="string" export-name="_script_output"/>
      <bind name="_application_number" type="number" export-name="_application_number"/>
      <bind name="_script_ExitCode" type="number" export-name="_script_ExitCode"/>
      <bind name="app_pak" type="Array/string" export-name="app_pak"/>
    </in-binding>
    <out-binding>
      <bind name="_error" type="string" export-name="_error"/>
      <bind name="_install_script" type="string" export-name="_install_script"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="347.13401221807305" x="685.9028554856667"/>
  </workflow-item>
  <workflow-item name="item19" out-name="item12" catch-name="item20" throw-bind-name="_error" type="task">
    <display-name><![CDATA[Validate the installation]]></display-name>
    <script encoded="false"><![CDATA[//설치 검증할 APPLICATION 변수로 설정 
System.log("Apps to Validate:" + app_pak[_application_number-1]);

//해당 APPLICATION에 대해서 스크립트 OUTPUT 을 찾아 해당 내용이 있으면 통과 
if(_script_ExitCode == "0") {
    System.log(app_pak[_application_number-1] + " - successfully installed")
}
else {
    System.log(app_pak[_application_number-1] + " - install failed")
    _error = app_pak[_application_number-1] + " - install failed"
    throw _error
}]]></script>
    <in-binding>
      <bind name="_script_output" type="string" export-name="_script_output"/>
      <bind name="_application_number" type="number" export-name="_application_number"/>
      <bind name="_script_ExitCode" type="number" export-name="_script_ExitCode"/>
      <bind name="app_pak" type="Array/string" export-name="app_pak"/>
    </in-binding>
    <out-binding>
      <bind name="_error" type="string" export-name="_error"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="133.07845666251748" x="694.7917443745556"/>
  </workflow-item>
  <workflow-item name="item20" business-status="Failed application install" throw-bind-name="_error" type="end" end-mode="1">
    <in-binding/>
    <position y="98.73118872431688" x="572.6434560270674"/>
  </workflow-item>
  <workflow-item name="item21" business-status="Failed application install" throw-bind-name="_error" type="end" end-mode="1">
    <in-binding/>
    <position y="341.13401221807305" x="570.3472999301111"/>
  </workflow-item>
  <workflow-item name="item30" out-name="item4" type="task" script-module="com.vmware.library.vc.vm.tools/vim3WaitToolsStarted">
    <display-name><![CDATA[Action element]]></display-name>
    <script encoded="false"><![CDATA[//Auto generated script, cannot be modified !
System.getModule("com.vmware.library.vc.vm.tools").vim3WaitToolsStarted(vm,pollingRate,timeout);
]]></script>
    <in-binding>
      <bind name="vm" type="VC:VirtualMachine" export-name="_vm_object"/>
      <bind name="pollingRate" type="number" export-name="pollingRate"/>
      <bind name="timeout" type="number" export-name="timeout"/>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Add a note to the workflow schema.]]></description>
    <position y="120.0" x="300.0"/>
  </workflow-item>
  <workflow-item name="item31" type="link" linked-workflow-id="064a275d-0b2a-4707-9f3c-b6e2fcfe4129">
    <display-name><![CDATA[Remove install file and script]]></display-name>
    <in-binding>
      <bind name="vm" type="VC:VirtualMachine" export-name="_vm_object"/>
      <bind name="username" type="string"/>
      <bind name="password" type="SecureString"/>
      <bind name="scriptType" type="string" export-name="_windows_script_type"/>
      <bind name="script" type="string" export-name="_install_script"/>
      <bind name="scriptTimeout" type="number" export-name="_scriptTimeout"/>
      <bind name="scriptRefreshTime" type="number" export-name=""/>
      <bind name="scriptWorkingDirectory" type="string" export-name=""/>
      <bind name="interactiveSession" type="boolean" export-name=""/>
    </in-binding>
    <out-binding>
      <bind name="scriptOutputText" type="string" export-name=""/>
      <bind name="scriptExitCode" type="number" export-name=""/>
    </out-binding>
    <description><![CDATA[ ]]></description>
    <position y="315.6127493818402" x="854.5653719194431"/>
  </workflow-item>
  <workflow-item name="item32" out-name="item5" type="task">
    <display-name><![CDATA[Get customProperties]]></display-name>
    <script encoded="false"><![CDATA[var customProperties = inputProperties.customProperties;
var appList = customProperties.packages;
var appParamList = customProperties.packagesParameter;
var parseToArray = System.getModule("com.clovir").parseStringToArray;
app_pak = parseToArray(appList);
app_pak_param = parseToArray(appParamList);]]></script>
    <in-binding>
      <bind name="inputProperties" type="Properties" export-name="inputProperties"/>
    </in-binding>
    <out-binding>
      <bind name="app_pak" type="Array/string" export-name="app_pak"/>
      <bind name="app_pak_param" type="Array/string" export-name="app_pak_param"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="40.0" x="140.0"/>
  </workflow-item>
  <workflow-item name="item33" type="end" end-mode="0">
    <in-binding/>
    <position y="170.0" x="120.0"/>
  </workflow-item>
  <workflow-item name="item34" out-name="item32" type="custom-condition" alt-out-name="item33">
    <display-name><![CDATA[Decision]]></display-name>
    <script encoded="false"><![CDATA[var customProperties = inputProperties.customProperties;
if (customProperties.packages !="[]"){
    return true;
} else {
    return false;
}]]></script>
    <in-binding>
      <bind name="inputProperties" type="Properties" export-name="inputProperties"/>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="100.0" x="80.0"/>
  </workflow-item>
  <presentation/>
</workflow>